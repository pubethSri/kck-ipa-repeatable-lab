<html>
<head>
    <title>Sample app</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

    <h1>Your are calling me from {{ request.remote_addr }}</h1>
    
    <div class="main-container">
        <!-- Chat Container -->
        <div class="container">
            <div class="chat-box" id="chatBox">
                {% for comment in data %}
                <div class="message-wrapper right">
                    <div class="message-bubble">
                        <div class="message-info">
                            <span class="username">{{ comment.yourname }}</span>
                            <span class="ip-address">{{ comment.ip_address }}</span>
                        </div>
                        <div class="message-text">{{ comment.message }}</div>
                        <form method="POST" action="{{ url_for('delete_comment') }}" class="delete-form">
                            <input type="hidden" name="idx" value="{{ loop.index0 }}">
                            <button type="submit" class="delete-btn">×</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>

            <form id="messageForm" class="add-form">
                <input id="yourname" name="yourname" placeholder="Your name" required class="input-name" />
                <textarea id="message" name="message" placeholder="Type your message..." required class="input-message" rows="2"></textarea>
                <button type="submit" class="add-btn">Send</button>
            </form>
        </div>

        <!-- Router Management Container -->
        <div class="container router-container">
            <div class="router-header">
                <h2>Router Management</h2>
            </div>

            <div class="router-content-horizontal">
                <div class="router-section">
                    <form method="POST" action="{{ url_for('add_router') }}" class="router-form">
                        <h3>Add New Router</h3>
                        <input type="text" name="ip" placeholder="IP Address" required class="router-input" />
                        <input type="text" name="username" placeholder="Username" required class="router-input" />
                        <input type="password" name="password" placeholder="Password" required class="router-input" />
                        <button type="submit" class="router-add-btn">ADD</button>
                    </form>
                </div>

                <div class="router-section">
                    <div class="router-list-section">
                        <h3>Router List</h3>
                        <div class="router-list" id="routerList">
                            {% for router in routers %}
                            <div class="router-item" data-router-id="{{ router._id }}">
                                <div class="router-info">
                                    <span class="router-ip">{{ router.ip }}</span>
                                    <span class="router-username">- {{ router.username }}</span>
                                </div>
                                <form method="POST" action="{{ url_for('delete_router', router_id=router._id) }}" style="display: inline;">
                                    <button type="submit" class="router-delete-btn">Delete</button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const chatBox = document.getElementById('chatBox');
        const messageForm = document.getElementById('messageForm');
        const yournameInput = document.getElementById('yourname');
        const messageInput = document.getElementById('message');
        const routerList = document.getElementById('routerList');
        
        // เก็บ IP ของตัวเอง
        const myIP = "{{ request.remote_addr }}";
        
        // ตรวจสอบการเชื่อมต่อ
        socket.on('connect', function() {
            console.log('Connected to WebSocket server');
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from WebSocket server');
        });

        // เมื่อได้รับข้อความใหม่จาก server
        socket.on('new_message', function(data) {
            console.log('Received message:', data);
            addMessageToChat(data);
            scrollToBottom();
        });

        // เมื่อมีข้อความถูกลบ
        socket.on('message_deleted', function(data) {
            location.reload();
        });

        // เมื่อมี router ใหม่
        socket.on('router_added', function(data) {
            location.reload();
        });

        // เมื่อมี router ถูกลบ
        socket.on('router_deleted', function(data) {
            location.reload();
        });

        // ส่งข้อความ
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const yourname = yournameInput.value.trim();
            const message = messageInput.value.trim();
            
            if (yourname && message) {
                console.log('Sending message:', {yourname, message});
                socket.emit('send_message', {
                    yourname: yourname,
                    message: message
                });
                
                messageInput.value = '';
                messageInput.focus();
            }
        });

        // ฟังก์ชันเพิ่มข้อความในแชท
        function addMessageToChat(data) {
            const messageWrapper = document.createElement('div');
            
            const isMyMessage = (data.ip_address === myIP);
            messageWrapper.className = isMyMessage ? 'message-wrapper right' : 'message-wrapper left';
            
            messageWrapper.innerHTML = `
                <div class="message-bubble">
                    <div class="message-info">
                        <span class="username">${escapeHtml(data.yourname)}</span>
                        <span class="ip-address">${escapeHtml(data.ip_address)}</span>
                    </div>
                    <div class="message-text">${escapeHtml(data.message)}</div>
                </div>
            `;
            
            chatBox.appendChild(messageWrapper);
        }

        // Scroll ลงล่างสุด
        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto scroll เมื่อโหลดหน้า
        window.addEventListener('load', scrollToBottom);
    </script>
</body>
</html>
